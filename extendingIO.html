<!DOCTYPE html>
<html>
<head>
  <meta name="author" content="Tim Holy">
  <meta charset="utf-8">
  <title>Extending IO</title>
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro:400,700'
        rel='stylesheet' type='text/css'>
  <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" media="all">
  <link href="css/custom.css" rel="stylesheet" type="text/css" media="all">
  <link href="css/hk-pyg.css" rel="stylesheet" type="text/css" media="all">
  <script src="js/jquery-2.0.3.min.js" type="text/javascript"></script>
  <script src="js/bootstrap.min.js" type="text/javascript"></script>
  <script src="js/list.min.js" type="text/javascript"></script>
</head>
<body>
  <div id="topbar" style="z-index: 3">
    <div class="container">
      <div class="row">
        <ul>
          <li><div id="pkgname">Images 0.4.34+</div></li>
          <li><a href="#">Code</a></li>
          <li><a href="#/issues">Issues</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="container" style="z-index: auto">
    <div class="row">
      <div class="col-sm-7">
      <div id="body-content">
<h1>
Image I/O
</h1>
<p><code>Images</code> supports a number of image file formats. Popular formats such as PNG, JPEG, and TIFF are currently loaded and saved via <a href="http://www.imagemagick.org/script/index.php">ImageMagick</a>.</p>
<p><code>Images</code> also supports a number of formats used more typically for scientific work:</p>
<ul>
<li><a href="http://teem.sourceforge.net/nrrd/">NRRD</a>, &quot;nearly raw raster data&quot; which despite its name allows for considerable metadata. Currently, this is perhaps the best default choice of formats for storing image data.</li>
<li>SIF, a file format used by Andor Technology for their scientific CCD cameras</li>
<li><a href="http://www.pco.de/links/">B16</a>, a format used by PCO/Cooke cameras</li>
<li><a href="http://holylab.wustl.edu/">Imagine</a>, a format used for 4D (3 spatial dimensions + time) imaging</li>
</ul>
<p>Finally, <a href="https://github.com/timholy/HDF5.jl">HDF5</a> and JLD can also be used to store images. There is an official <a href="http://www.hdfgroup.org/HDF5/doc/ADGuide/ImageSpec.html">HDF5 image standard</a>, which we could fairly easily support, but the author's searching has yet to turn up an example file that complies with this standard. Many HDF5 images seem to be stored with custom attributes, which fortunately are quite easy to parse.</p>
<p>To read an image, one typically says</p>
<pre class="sourceCode julia julia" execute="false"><code class="sourceCode julia">img = imread(<span class="st">&quot;filename.fmt&quot;</span>)</code></pre>
<p>and to write,</p>
<pre class="sourceCode julia julia" execute="false"><code class="sourceCode julia">imwrite(img, <span class="st">&quot;filename.fmt&quot;</span>)</code></pre>
<p>You can read from streams and control format this way:</p>
<pre class="sourceCode julia julia" execute="false"><code class="sourceCode julia">img = imread(stream, Images.NRRDFile)</code></pre>
<p>would load an image from a stream, interpreting it as having NRRD format. The stream should already be advanced past the format's magic bytes.</p>
<h1 id="extending-image-io">Extending Image I/O</h1>
<p>It is not difficult to extend the <code>Images</code> library to handle custom image files. For an example, here are the essential steps to set up support for a <code>.sif</code> file.</p>
<h1 id="implementation-for-personal-use">Implementation for personal use</h1>
<p>All of the following code is found in one file, <code>SIF.jl</code>.</p>
<p>First, we create a new type for the image, whose parent is <code>Images.ImageFileType</code>. Next, we register the <code>.sif</code> extension and the &quot;magic bytes&quot; to the new type. The magic bytes are found at the start of the file and are used to uniquely identify the format.</p>
<pre class="sourceCode julia julia" execute="false"><code class="sourceCode julia"><span class="co"># SIF.jl, adds an imread function for Andor .sif images</span>

using Images

<span class="kw">type</span> AndorSIF &lt;: Images.ImageFileType <span class="kw">end</span>
add_image_file_format(<span class="st">&quot;.sif&quot;</span>, b<span class="st">&quot;Andor Technology Multi-Channel File&quot;</span>, AndorSIF)</code></pre>
<p>Next, we create an imread function to handle the new image type. But first, we have to explicitly import the imread function so that we can extend it:</p>
<pre class="sourceCode julia julia" execute="false"><code class="sourceCode julia"><span class="kw">import</span> Images.imread
<span class="kw">function</span> imread{S&lt;:<span class="dt">IO</span>}(stream::S, ::<span class="dt">Type</span>{AndorSIF})
    seek(stream, <span class="fl">0</span>)
    l = strip(readline(stream))
    l == <span class="st">&quot;Andor Technology Multi-Channel File&quot;</span> ||
         error(<span class="st">&quot;Not an Andor file: &quot;</span> * l)</code></pre>
<p>When this imread is called, the magic bytes have already been read from the stream. In this case, it's easier to parse the header if we start over from the beginning of the file with the <code>seek(stream, 0)</code> statement.</p>
<p>Next, we parse the header information. Many of the fields in this file are space delimited within lines. If something unexpected is read, we spit out an error (very important when the file format changes, pulling out the rug from underneath you). This particular file type has a large number of fields. For completeness, we will store all of these fields in a <code>Dict</code> named <code>ixon</code>:</p>
<pre class="sourceCode julia julia" execute="false"><code class="sourceCode julia"><span class="co"># ...skipped a few uninteresting fields before here</span>
l = strip(readline(stream))
fields = split(l)
fields[<span class="fl">1</span>] == <span class="st">&quot;65547&quot;</span> || fields[<span class="fl">1</span>] == <span class="st">&quot;65558&quot;</span> ||
    error(<span class="st">&quot;Unknown TInstaImage version number at line 3: &quot;</span> * fields[<span class="fl">1</span>])

ixon = {<span class="st">&quot;data_type&quot;</span> =&gt; int(fields[<span class="fl">2</span>])}
ixon[<span class="st">&quot;active&quot;</span>] = int(fields[<span class="fl">3</span>])
ixon[<span class="st">&quot;structure_vers&quot;</span>] = int(fields[<span class="fl">4</span>]) <span class="co"># (== 1)</span>
<span class="co"># ...and skip a whole bunch of uninteresting fields after here</span></code></pre>
<p>We keep reading and parsing the image header until we reach the first byte of the actual image data. Along the way, we collect variables <code>width</code>, <code>height</code>, and <code>frames</code> (this image file is actually a 3D array, an image sequence over time). Now we are ready to read the actual pixel data:</p>
<pre class="sourceCode julia julia" execute="false"><code class="sourceCode julia">pixels = read(stream, <span class="dt">Float32</span>, width, height, frames)</code></pre>
<p>Finally, we wrap up by setting the properties, including the new <code>ixon</code> collection with suppressed printing, and return the <code>Image</code>:</p>
<pre class="sourceCode julia julia" execute="false"><code class="sourceCode julia">prop = {<span class="st">&quot;colorspace&quot;</span> =&gt; <span class="st">&quot;Gray&quot;</span>,
        <span class="st">&quot;spatialorder&quot;</span> =&gt; [<span class="st">&quot;y&quot;</span>, <span class="st">&quot;x&quot;</span>, <span class="st">&quot;t&quot;</span>],
        <span class="st">&quot;ixon&quot;</span> =&gt; ixon,
        <span class="st">&quot;suppress&quot;</span> =&gt; <span class="dt">Set</span>({<span class="st">&quot;ixon&quot;</span>})}
Image(pixels, prop)
<span class="kw">end</span> <span class="co"># imread()</span></code></pre>
<h1 id="contributing-a-file-format-to-images">Contributing a file format to Images</h1>
<p>To make your file format available to others, only a few changes are needed. First, move your &quot;registration&quot; code from <code>SIF.jl</code> to Images' <code>io.jl</code>:</p>
<pre class="sourceCode julia julia" execute="false"><code class="sourceCode julia"><span class="kw">type</span> AndorSIF &lt;: ImageFileType <span class="kw">end</span>
add_image_file_format(<span class="st">&quot;.sif&quot;</span>, b<span class="st">&quot;Andor Technology Multi-Channel File&quot;</span>, AndorSIF,
<span class="st">&quot;SIF.jl&quot;</span>)</code></pre>
<p>Note that we've added one more argument to this function, the <code>&quot;SIF.jl&quot;</code> string. By supplying a filename, you're setting it up so that the code to handle SIF images is loaded automatically the first time you try to read or write a SIF file.</p>
<p>Second, the <code>AndorSIF</code> type is now found in the <code>Images</code> module, so tell the <code>imread</code> call to look there in <code>SIF.jl</code>:</p>
<pre class="sourceCode julia julia" execute="false"><code class="sourceCode julia"><span class="kw">function</span> imread{S&lt;:<span class="dt">IO</span>}(stream::S, ::<span class="dt">Type</span>{Images.AndorSIF})</code></pre>
<p>The final step is to take <code>SIF.jl</code> and add it to the <code>ioformats</code> directory (inside <code>src/</code>). Submit a pull request, and once merged your format will be usable by anyone.</p>
        <hr>
      </div>
      </div>

      <div class="col-sm-offset-8" style="z-index: 2">
        <div id="table-of-contents">
          <div id="table-of-contents-content">
            <input class="search" placeholder="SEARCH" />
            <ul class="toc list nav"><li>
                <a class="toc-item" href="index.html">Introduction</a>
            </li>
            <li>
                <a class="toc-item" href="aims.html">Aims</a>
            </li>
            <li>
                <a class="toc-item" href="install.html">Installation</a>
            </li>
            <li>
                <a class="toc-item" href="core.html">Core Concepts</a>
            </li>
            <li>
                <a class="toc-item" href="function_reference.html">Function Reference</a>
            </li>
            <li>
                <a class="toc-item" href="overlays.html">Overlays</a>
            </li>
            <li>
                <a class="toc-item toc-current-doc" href="extendingIO.html">Extending IO</a>
            </li>
            <li>
                <a style="margin-left: 0.5em" class="toc-item" href="#extending-image-io">Extending Image I/O</a>
            </li>
            <li>
                <a style="margin-left: 0.5em" class="toc-item" href="#implementation-for-personal-use">Implementation for personal use</a>
            </li>
            <li>
                <a style="margin-left: 0.5em" class="toc-item" href="#contributing-a-file-format-to-images">Contributing a file format to Images</a>
            </li>
            <li>
                <a class="toc-item" href="fixing_breakages.html">Troubleshooting</a>
            </li>
            <li>
                <a class="toc-item" href="status.html">Development Status</a>
            </li>
            </ul>

            <script>
                var toclist = new List("table-of-contents",
                                       {valueNames: ["toc-item"]})

                $("body").scrollspy({target: "#table-of-contents"});

                $("#table-of-contents li").on("activate.bs.scrollspy",
                    function(event) {
                        $("#table-of-contents ul").find("a").css({"font-weight": "normal"});
                        $(this).children("a").css({"font-weight": "bolder"});
                    });
            </script>
          </div>
        </div>
      </div>
    </div>

  <footer class="col-sm-8">
    <p class="muted">Last modified by Tim Holy on Sun Apr 12 10:55:49 CDT 2015. Generated with
    <a href="https://github.com/dcjones/Judo.jl">Judo</a>.</p>
  </footer>

  </div>
</body>
</html>

