<!DOCTYPE html>
<html>
<head>
  <meta name="author" content="Tim Holy">
  <meta charset="utf-8">
  <title>Extending IO</title>
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro:400,700'
        rel='stylesheet' type='text/css'>
  <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" media="all">
  <link href="css/custom.css" rel="stylesheet" type="text/css" media="all">
  <link href="css/hk-pyg.css" rel="stylesheet" type="text/css" media="all">
  <script src="js/jquery-2.0.3.min.js" type="text/javascript"></script>
  <script src="js/bootstrap.min.js" type="text/javascript"></script>
  <script src="js/list.min.js" type="text/javascript"></script>
</head>
<body>
  <div id="topbar" style="z-index: 3">
    <div class="container">
      <div class="row">
        <ul>
          <li><div id="pkgname">Images 0.4.47+</div></li>
          <li><a href="http:&#x2F;&#x2F;github.com&#x2F;timholy&#x2F;Images.jl">Code</a></li>
          <li><a href="http:&#x2F;&#x2F;github.com&#x2F;timholy&#x2F;Images.jl/issues">Issues</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="container" style="z-index: auto">
    <div class="row">
      <div class="col-sm-7">
      <div id="body-content">
      <h1>Image I/O</h1>
<p><code>Images</code> supports a number of image file formats. Popular formats such as PNG, JPEG, and TIFF are currently loaded and saved via <a href="http://www.imagemagick.org/script/index.php">ImageMagick</a>.</p>
<p><code>Images</code> also supports a number of formats used more typically for scientific work:</p>
<ul>
<li><a href="http://teem.sourceforge.net/nrrd/">NRRD</a>, &quot;nearly raw raster data&quot; which   despite its name allows for considerable metadata. Currently, this is perhaps   the best default choice of formats for storing image data.</li>
<li>SIF, a file format used by Andor Technology for their scientific CCD cameras</li>
<li><a href="http://www.pco.de/links/">B16</a>, a format used by PCO/Cooke cameras</li>
<li><a href="http://holylab.wustl.edu/">Imagine</a>, a format used for 4D &#40;3 spatial   dimensions &#43; time&#41; imaging</li>
</ul>
<p>Finally, <a href="https://github.com/timholy/HDF5.jl">HDF5</a> and JLD can also be used to store images. There is an official <a href="http://www.hdfgroup.org/HDF5/doc/ADGuide/ImageSpec.html">HDF5 image standard</a>, which we could fairly easily support, but the author&#39;s searching has yet to turn up an example file that complies with this standard.  Many HDF5 images seem to be stored with custom attributes, which fortunately are quite easy to parse.</p>
<p>To read an image, one typically says</p>
<pre><code class="language-&#123;.julia execute&#61;&quot;false&quot;&#125;">img &#61; imread&#40;&quot;filename.fmt&quot;&#41;</code></pre>
<p>and to write,</p>
<pre><code class="language-&#123;.julia execute&#61;&quot;false&quot;&#125;">imwrite&#40;img, &quot;filename.fmt&quot;&#41;</code></pre>
<p>You can read from streams and control format this way:</p>
<pre><code class="language-&#123;.julia execute&#61;&quot;false&quot;&#125;">img &#61; imread&#40;stream, Images.NRRDFile&#41;</code></pre>
<p>would load an image from a stream, interpreting it as having NRRD format. The stream should already be advanced past the format&#39;s magic bytes.</p>
<h1 id="extending-image-io">Extending Image I/O</h1>
<p>It is not difficult to extend the <code>Images</code> library to handle custom image files. For an example, here are the essential steps to set up support for a <code>.sif</code> file.</p>
<h1 id="implementation-for-personal-use">Implementation for personal use</h1>
<p>All of the following code is found in one file, <code>SIF.jl</code>.</p>
<p>First, we create a new type for the image, whose parent is <code>Images.ImageFileType</code>.  Next, we register the <code>.sif</code> extension and the &quot;magic bytes&quot; to the new type.  The magic bytes are found at the start of the file and are used to uniquely identify the format.</p>
<pre><code class="language-&#123;.julia execute&#61;&quot;false&quot;&#125;"># SIF.jl, adds an imread function for Andor .sif images

using Images

type AndorSIF &lt;: Images.ImageFileType end
add_image_file_format&#40;&quot;.sif&quot;, b&quot;Andor Technology Multi-Channel File&quot;, AndorSIF&#41;</code></pre>
<p>Next, we create an imread function to handle the new image type.  But first, we have to explicitly import the imread function so that we can extend it:</p>
<pre><code class="language-&#123;.julia execute&#61;&quot;false&quot;&#125;">import Images.imread
function imread&#123;S&lt;:IO&#125;&#40;stream::S, ::Type&#123;AndorSIF&#125;&#41;
    seek&#40;stream, 0&#41;
    l &#61; strip&#40;readline&#40;stream&#41;&#41;
    l &#61;&#61; &quot;Andor Technology Multi-Channel File&quot; ||
         error&#40;&quot;Not an Andor file: &quot; * l&#41;</code></pre>
<p>When this imread is called, the magic bytes have already been read from the stream.  In this case, it&#39;s easier to parse the header if we start over from the beginning of the file with the <code>seek&#40;stream, 0&#41;</code> statement.</p>
<p>Next, we parse the header information.  Many of the fields in this file are space delimited within lines.  If something unexpected is read, we spit out an error &#40;very important when the file format changes, pulling out the rug from underneath you&#41;.  This particular file type has a large number of fields.  For completeness, we will store all of these fields in a <code>Dict</code> named <code>ixon</code>:</p>
<pre><code class="language-&#123;.julia execute&#61;&quot;false&quot;&#125;"># ...skipped a few uninteresting fields before here
l &#61; strip&#40;readline&#40;stream&#41;&#41;
fields &#61; split&#40;l&#41;
fields&#91;1&#93; &#61;&#61; &quot;65547&quot; || fields&#91;1&#93; &#61;&#61; &quot;65558&quot; ||
    error&#40;&quot;Unknown TInstaImage version number at line 3: &quot; * fields&#91;1&#93;&#41;

ixon &#61; &#123;&quot;data_type&quot; &#61;&gt; convert&#40;Int,fields&#91;2&#93;&#41;&#125;
ixon&#91;&quot;active&quot;&#93; &#61; convert&#40;Int,fields&#91;3&#93;&#41;
ixon&#91;&quot;structure_vers&quot;&#93; &#61; convert&#40;Int,fields&#91;4&#93;&#41; # &#40;&#61;&#61; 1&#41;
# ...and skip a whole bunch of uninteresting fields after here</code></pre>
<p>We keep reading and parsing the image header until we reach the first byte of the actual image data.  Along the way, we collect variables <code>width</code>, <code>height</code>, and <code>frames</code> &#40;this image file is actually a 3D array, an image sequence over time&#41;.  Now we are ready to read the actual pixel data:</p>
<pre><code class="language-&#123;.julia execute&#61;&quot;false&quot;&#125;">pixels &#61; read&#40;stream, Float32, width, height, frames&#41;</code></pre>
<p>Finally, we wrap up by setting the properties, including the new <code>ixon</code> collection with suppressed printing, and return the <code>Image</code>:</p>
<pre><code class="language-&#123;.julia execute&#61;&quot;false&quot;&#125;">prop &#61; &#123;&quot;colorspace&quot; &#61;&gt; &quot;Gray&quot;,
        &quot;spatialorder&quot; &#61;&gt; &#91;&quot;y&quot;, &quot;x&quot;, &quot;t&quot;&#93;,
        &quot;ixon&quot; &#61;&gt; ixon,
        &quot;suppress&quot; &#61;&gt; Set&#40;&#123;&quot;ixon&quot;&#125;&#41;&#125;
Image&#40;pixels, prop&#41;
end # imread&#40;&#41;</code></pre>
<h1 id="contributing-a-file-format-to-images">Contributing a file format to Images</h1>
<p>To make your file format available to others, only a few changes are needed. First, move your &quot;registration&quot; code from <code>SIF.jl</code> to Images&#39; <code>io.jl</code>:</p>
<pre><code class="language-&#123;.julia execute&#61;&quot;false&quot;&#125;">type AndorSIF &lt;: ImageFileType end
add_image_file_format&#40;&quot;.sif&quot;, b&quot;Andor Technology Multi-Channel File&quot;, AndorSIF,
&quot;SIF.jl&quot;&#41;</code></pre>
<p>Note that we&#39;ve added one more argument to this function, the <code>&quot;SIF.jl&quot;</code> string. By supplying a filename, you&#39;re setting it up so that the code to handle SIF images is loaded automatically the first time you try to read or write a SIF file.</p>
<p>Second, the <code>AndorSIF</code> type is now found in the <code>Images</code> module, so tell the <code>imread</code> call to look there in <code>SIF.jl</code>:</p>
<pre><code class="language-&#123;.julia execute&#61;&quot;false&quot;&#125;">function imread&#123;S&lt;:IO&#125;&#40;stream::S, ::Type&#123;Images.AndorSIF&#125;&#41;</code></pre>
<p>The final step is to take <code>SIF.jl</code> and add it to the <code>ioformats</code> directory &#40;inside <code>src/</code>&#41;. Submit a pull request, and once merged your format will be usable by anyone.</p>

      <hr>
      </div>
      </div>

      <div class="col-sm-offset-8" style="z-index: 2">
        <div id="table-of-contents">
          <div id="table-of-contents-content">
            <input class="search" placeholder="SEARCH" />
            <ul class="toc list nav"><li>
    <a class="toc-item" href="index.html">Introduction</a>
</li>
<li>
    <a class="toc-item" href="aims.html">Aims</a>
</li>
<li>
    <a class="toc-item" href="install.html">Installation</a>
</li>
<li>
    <a class="toc-item" href="core.html">Core Concepts</a>
</li>
<li>
    <a class="toc-item" href="function_reference.html">Function Reference</a>
</li>
<li>
    <a class="toc-item" href="overlays.html">Overlays</a>
</li>
<li>
    <a class="toc-item toc-current-doc" href="extendingIO.html">Extending IO</a>
</li>
<li>
    <a style="margin-left: 0.5em" class="toc-item" href="#extending-image-io">Extending Image I/O</a>
</li>
<li>
    <a style="margin-left: 0.5em" class="toc-item" href="#implementation-for-personal-use">Implementation for personal use</a>
</li>
<li>
    <a style="margin-left: 0.5em" class="toc-item" href="#contributing-a-file-format-to-images">Contributing a file format to Images</a>
</li>
<li>
    <a class="toc-item" href="status.html">Development Status</a>
</li>
</ul>

            <script>
                var toclist = new List("table-of-contents",
                                       {valueNames: ["toc-item"]})

                $("body").scrollspy({target: "#table-of-contents"});

                $("#table-of-contents li").on("activate.bs.scrollspy",
                    function(event) {
                        $("#table-of-contents ul").find("a").css({"font-weight": "normal"});
                        $(this).children("a").css({"font-weight": "bolder"});
                    });
            </script>
          </div>
        </div>
      </div>
    </div>

  <footer class="col-sm-8">
    <p class="muted">Last modified by Tim Holy on . Generated with
    <a href="https://github.com/dcjones/Judo.jl">Judo</a>.</p>
  </footer>

  </div>
</body>
</html>

